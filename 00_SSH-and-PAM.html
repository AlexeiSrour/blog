<!DOCTYPE html><html><head><title>Alexei Srour's Blog | My experience configuring SSH, PAM, port forwarding, and two-factor authentication for global access to my home PC</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><meta name="robots" content="index,follow"><meta name="theme-color" content="#212121"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><link rel="shortcut icon" href="/coding-blog-boilerplate/favicon.ico"><link href="https://fonts.googleapis.com/css?family=Hind:400,700&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:300,400&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/icon?family=Material+Icons%7CMaterial+Icons+Outlined&amp;display=swap" rel="stylesheet"><style>
      body, input, button {
        font-family: 'Hind', sans-serif;
      }

      code, .hljs {
        font-family: 'Source Code Pro', 'Courier New', Courier, monospace;
      }

      .icon-font {
        font-family: 'Material Icons';
        font-weight: normal;
        font-style: normal;
        font-size: 24px;  /* Preferred icon size */
        display: inline-block;
        line-height: 1;
        text-transform: none;
        letter-spacing: normal;
        word-wrap: normal;
        white-space: nowrap;
        direction: ltr;
      
        /* Support for all WebKit browsers. */
        -webkit-font-smoothing: antialiased;
        /* Support for Safari and Chrome. */
        text-rendering: optimizeLegibility;
      
        /* Support for Firefox. */
        -moz-osx-font-smoothing: grayscale;
      
        /* Support for IE. */
        font-feature-settings: 'liga';
      }

      .icon-font.outline {
        font-family: 'Material Icons Outlined';
      }
    </style><link href="/coding-blog-boilerplate/styles/codedoc-styles.css" rel="stylesheet"><script async="" defer="" src="/coding-blog-boilerplate/bundle/codedoc-bundle.js"></script><script>window.githubConfig={"repo":"coding-blog-boilerplate","user":"AlexeiSrour"}</script><style>.container{padding-top: 0 !important}</style><style>#-codedoc-toc { backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px) }</style><meta name="twitter:title" content="Alexei Srour's Blog | My experience configuring SSH, PAM, port forwarding, and two-factor authentication for global access to my home PC"><meta property="og:type" content="article"><meta property="og:title" content="Alexei Srour's Blog | My experience configuring SSH, PAM, port forwarding, and two-factor authentication for global access to my home PC"><meta property="og:image" content="https://images.unsplash.com/photo-1486312338219-ce68d2c6f44d?w=1900&amp;h=600&amp;fit=crop"><meta name="keywords" content=""><meta property="blog-tags" content=""></head><body><div class="header-0-0-7"><a class="watermark-0-0-6" href="https://coding.blog" target="_blank"><svg viewBox="0 0 701 443" version="1.1" xmlns="http://www.w3.org/2000/svg"><g id="coding.blog" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g transform="translate(-162.000000, -246.000000)" id="Shape"><path d="M538.081948,246.348452 L538.52402,246.445719 L538.52402,246.445719 L538.85529,246.526578 L538.85529,246.526578 L600.956012,263.165455 C602.767076,263.660918 604.526214,264.465865 606.146589,265.591976 C611.80881,269.527048 614.090389,276.211909 612.345003,282.123825 L538.2641,559.728905 C537.816127,561.562539 536.989561,563.335054 535.765607,564.944016 C530.70443,571.597248 520.764856,572.934442 513.564947,567.930724 C507.902727,563.995652 505.621148,557.310791 507.366534,551.398875 L577.145082,289.91439 L546.233523,281.631663 L462.305576,595.917544 L468.439004,634.645619 L493.907962,603.194573 C499.468987,596.327279 509.54413,595.268339 516.411424,600.829364 C523.278717,606.390389 524.337658,616.465532 518.776633,623.332826 L470.948283,682.395919 C466.887248,687.410879 460.418878,689.3283 454.55045,687.832105 L454.212574,687.741996 C448.224449,686.200133 443.421088,681.240355 442.392221,674.744345 L430.503202,599.680031 C430.418831,599.147339 430.361793,598.616628 430.331048,598.089327 C429.783912,595.705405 429.838457,593.220092 430.535776,590.858154 L519.361965,258.223717 L519.447729,257.889555 L519.447729,257.889555 L519.532157,257.586199 L519.627058,257.23399 C520.074771,255.398716 520.901697,253.624577 522.126677,252.014264 C525.828762,247.147643 532.141006,245.125338 538.081948,246.348452 Z M632.156421,656.157784 C640.992977,656.157784 648.156421,663.321228 648.156421,672.157784 C648.156421,680.99434 640.992977,688.157784 632.156421,688.157784 L528.156421,688.157784 C519.319865,688.157784 512.156421,680.99434 512.156421,672.157784 C512.156421,663.321228 519.319865,656.157784 528.156421,656.157784 L632.156421,656.157784 Z M699.234631,342.452157 L857.62655,500.844076 C863.874939,507.092464 863.874939,517.223104 857.62655,523.471493 L699.234631,681.863412 C692.986243,688.1118 682.855603,688.1118 676.607214,681.863412 C670.358826,675.615023 670.358826,665.484383 676.607214,659.235995 L823.686132,512.157077 L676.607214,365.079574 C670.358826,358.831185 670.358826,348.700545 676.607214,342.452157 C682.855603,336.203768 692.986243,336.203768 699.234631,342.452157 Z M347.705627,342.452157 C353.954016,348.700545 353.954016,358.831185 347.705627,365.079574 L200.62671,512.158491 L347.705627,659.235995 C353.954016,665.484383 353.954016,675.615023 347.705627,681.863412 C341.457239,688.1118 331.326599,688.1118 325.07821,681.863412 L166.686292,523.471493 C160.437903,517.223104 160.437903,507.092464 166.686292,500.844076 L325.07821,342.452157 C331.326599,336.203768 341.457239,336.203768 347.705627,342.452157 Z"></path></g></g></svg></a></div><div id="-codedoc-container" class="container"><script>window.source = {"base":"posts","path":"00_SSH-and-PAM.md","namespace":"/coding-blog-boilerplate","title":{"base":"Alexei Srour's Blog","connector":" | "}}</script><div class="hero-0-0-1" data-mode="light" data-target="desktop" style="margin-bottom: -156px"><picture><source media="(min-width: 1025px)" srcset="https://images.unsplash.com/photo-1486312338219-ce68d2c6f44d?w=1900&amp;h=600&amp;fit=crop"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=" class="image-0-0-2" data-src="https://images.unsplash.com/photo-1486312338219-ce68d2c6f44d?w=1900&amp;h=600&amp;fit=crop" data-hero=""></picture><span class="caption-0-0-3"></span></div><div class="hero-0-0-1" data-mode="light" data-target="mobile" style="margin-bottom: -96px"><picture><source media="(max-width: 1024px)" srcset="https://images.unsplash.com/photo-1486312338219-ce68d2c6f44d?w=1200&amp;h=600&amp;fit=crop"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=" class="image-0-0-2" data-src="https://images.unsplash.com/photo-1486312338219-ce68d2c6f44d?w=1200&amp;h=600&amp;fit=crop" data-hero=""></picture><span class="caption-0-0-3"></span></div><div class="hero-0-0-1" data-mode="dark" data-target="desktop" style="margin-bottom: -156px"><picture><source media="(min-width: 1025px)" srcset="https://images.unsplash.com/photo-1508780709619-79562169bc64?w=1900&amp;h=600&amp;fit=crop"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=" class="image-0-0-2" data-src="https://images.unsplash.com/photo-1508780709619-79562169bc64?w=1900&amp;h=600&amp;fit=crop" data-hero=""></picture><span class="caption-0-0-3"></span></div><div class="hero-0-0-1" data-mode="dark" data-target="mobile" style="margin-bottom: -96px"><picture><source media="(max-width: 1024px)" srcset="https://images.unsplash.com/photo-1508780709619-79562169bc64?w=1200&amp;h=600&amp;fit=crop"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=" class="image-0-0-2" data-src="https://images.unsplash.com/photo-1508780709619-79562169bc64?w=1200&amp;h=600&amp;fit=crop" data-hero=""></picture><span class="caption-0-0-3"></span></div><h1 class="h-0-0-4 white"><span style=" 
      text-shadow: 0 0 8px black; 
      font-size: 48px"><p>My experience configuring SSH, PAM, port forwarding, and two-factor authentication for global access to my home PC</p></span></h1><script id="ASWYbZUVZT">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("ASWYbZUVZT", "tvU4ZvTyVzKC9UotaYeV1w==", {"src":"github"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script><marker><br>

</marker><p>Disclaimer: I am no expert in matters of internet security. This post is a recounting of the problems and solutions discovered in creating a globally accessible home network that was too my personal liking</p><p>firstly, there were three possible solutions to my desire to access my home PC. We had self hosting a VPN, we had paid services like tailscale that provide servers and services to tunnel through, and finally we have portforwarding and SSH</p><p>my issues with VPN is that it looked to be hours of research and I wanted something up and running now. Moreover, I'm not entirely clear how using a VPN replaces a hardened SSH connection. Tailscale looks like a handy service and would have been my selection of choice as it meets my needs, except for the install required. Still, honourable mention to Tailscale. Finally, I opted for SSH and portforwarding because it's a solution I'm already partially familiar with, it will be nice and portable, and its something I <strong>thought</strong> I could get up and running fairly quickly.</p><p>I'm not the first to think about this, and there's a plethora of resources out there pointing out potential dangers and workarounds to help make this safer. This post is one such example</p><p>Evidently, portforwarding and opening up a personal PC to the world wide web is a scary proposition. To help mitigate the dangers, I've opted to harden global SSH connections with a strategy of non-standard ports pubkey authentication, two-factor authentication, rate limiting, and I intend to further enhance the security by adding things like fail2ban and air gapping this PC. Furhter customisation of PAM could be possible to seriously limit global connection's access rights compared to local connections. All this, while keeping the local SSH experience as transparent and the same as usual.</p><p>I'll also be sharing some of the techniques I learnt such as journalling or PAM debug to help myself configure this stuff. Rather than outright telling you the config I used, I want to walk through the experience to help this be a learnable thingamabob</p><p>but, link for the lazy, provide a quick and dirty summary in tabs or link to a github texdump of all my info up front to save time.</p><p>Attempt 1: configuring everything from SSHD</p><p>first attempts were to keep things simple and local to my SSHD config. one of the most common first recommendations is to allow only pubkey authentication, with no password and no root login capablities. To first lay down the groundwork, creating the keys works by firstly generating the pub-private pair on the computer which you want to have access, and then saving the pubkey to the .ssh/authorized_keys file, noting that I follow XDG so .ssh is saved in .config. at this stage, restart sshd and sshd default configs probably already let you log in without password, neat. Note, it'd be cool to set up a way to auto restart sshd when editing .ssh/authorized_keys, pam.d/sshd/, /etc/ssh/sshd_config for conveniene, there's a luke video on this somewhere. Also that linux bunnyhop guy on how to do fuzzy finds script</p><p>Next would be disabling password logins and root logins, in essence only allowing pubkey logins. finally, assign your pc a static local ip address and open up a port to point at port 22 of the ip address of your computer. At this stage, for some, this would be enough( not quite! change valid authentication types to by only pubkey) ! the authorized keys list acts as a white list allowing only preconfigured in advanced computers to access the pc, and the non standard port will help prevent the majority of bots scraping random ip addresses from finding your PC, but this leaves a lot to be desired.</p><p>for one, even local network connections will require keys, so there will now be setup involved for each new local PC that you want to SSH from. Heavens forbid you lose access to an already allowed pc and you need to connect via local terminal which might just not be on. There's also the potential issue of if you configure a pc from outside your local network to access the server with a pubkey. This is alright if it's something like a laptop you have on the go, but if you setup a public PC like a library (stupid, don't do this), suddenly anyone out in the wild that can touch your laptop or public PC may just waltz in through the front door and access your home PC. We'll tackle each of these issues in order, the first using match statement in the SSHD config, and the other by enabling 2FA via PAM...and all the headaches that brought along.</p><p>Attempt 2: making the local network experience more seamless
using match statments</p><p>A feature present in the sshd_config is the ability to make a conditional block that can overwrite previous options; the Match statement. It provides a list of possible porperties that you can test patterns against, and the pattern matching itself features some basic regex ability, namely '*' and '?' characters. Of particular interest to us is the 'Address' property, and being able to match all local IP addresses. To that end, here's what the sshd_config file will look like, with the top half being the defaults for global connections, and the bottom being a match and changes for made for when a connection from a local system is being made. Don't forget to restard sshd after making any changes:</p><p>From the config, we can see that by default, passwords, keyboards, and authenticaion methods only list pubkey i.e. this is our config for the global network case. Beneath it in the match statement, we can see that we've enabled passwords and keyboards, and added a new authentication method delimited by white space (meaning or) so that either password or pubkey is valid, this is our overwrites for the local case. Spoiler warning in advance, don't get too attached to this version as only the authentication method list will be retained once 2fa and pam are enabled, due to a host of reasons.</p><p>With this configuration, all incoming connections from outside the network will only be accepted with a pubkey and a pubkey only. It will be automatically rejected otherwise. On the other hand, local network ssh experience has been restored, now allowing both pubkey login so you maintain that convenience, but also allowing password logins, so as long as you are connected somewhere on your home network, you can always connect with all your devices without prior setup.</p><p>Alas, connections from outside the network only require the pubkey, which that is already sufficiently protected for most, I felt a bit uneasy that my connection from outside the local network is that straightforward. A new layer of protection to introduce is 2fa using googles authentication client, and enabling it will involve enabling PAM which throws a spanner in the works for our current setup and some of the config file will have to be undone, but first the easy part.</p><p>Attempt 3a: setting up 2fa
first get 2fa working, then talk about enabling PAM, then talk about all the reconfiguration issues involved</p><p>you'll require google authenticator to already be working for this next part.</p><p>An installation of libpam-google-authenticator will be the package that will be responsible for generating and validating our 2fa codes. For this, we'll need to install the package, as well as qrencode for the convenience. Run the command google-authenticator in your terminal, and walk through the commands and setup those options.</p><p>If a time dependant code is being used (recommended), a prompt to enter the code before proceeding. This is the first stage at which you can pick up if something is wrong. If despite however many attempts to use the code when you swear it's right, or the amount of resetting up (i.e. rescanning the qr code) if you keep bumping into this issue, then it is likey your time isn't correctly synced. It turns out that OTP uses a time based algorithm, and the machine accepting the code and the machine generating the code must agree to the time.</p><p>Thankfully, this is relatively straightforward on the major linux distributions. A quick timedatectl will list out the status of the ntp service and the current time the machine thinks it is. If the ntp service is deactivated, then a sudo timedatectl set-ntp true ought to fix it and your time will be up to date. Any potential futher errors might need you to first install an NTP client, i.e. sudo pacman -S ntp before running the timedatectl, but at this stage any further issues you should consult the all knowing google before proceeding.</p><p>make short comment on the other options, but note that rate limiting will be something that you can further enforce for all logins, not just OTP</p><p>Once set up, it's time to tell our sshd daemon to use google authenticator</p><p>attempt 3b: setting up sshd to work with pam
talk how to get a quick and dirty pam setup out the gate, and then talk about all the shortcomings, which should then lead to bleugh</p><p>We have a google authenticator library sitting on the computer, it is now a matter of configuring sshd, and our pam module itself, to use it. To start, we'll just get something quick and dirty (and technically incorrect) up and running, and explain after the fact whay pam is, why pam is, and how to frame working with pam.</p><p>Focusing on our global networking defaults, to use 2fa, we require ssh to enable keybdinteractiveauth - aftger all, how can we expect to insert our 2fa code without this option. secondly, 2fa is a form of challenge-response authentication, where our home pc challenges us with a code requirement and we provide it via out google auth app. Therefore, we need to enable challengeresponsauth for 2fa to work correctly. The second to last change to make is to add keybaord interactive as a valid authentication method after pubkey. To do this, we simply create a comma delimted list where after pubkey we write keyboardauth:pam. Contrast this with our local network config where pubkey and password were separated by a space; space means or, a comma is a 'and then' required, mean our global network config now require a pubkey first, then our 2fa code.</p><p>The last change to make to our sshd config is to set the usePAM to yes. Committing this file to disk and then restarting sshd will now completely delegate the majority of authentication tasks over to PAM instead of our sshdaemon. That is to say, our sshd config is now technically broken and some things are going to get weird since we've approached our configs all wrong. Pam is all encompassing and once it is enabled, it should be the only thing you're using. An explanation will be made further below, but first we ought to configure our sshd pam module now. going to etc/pam.d/sshd is the pam configuration for sshd. add the google auth line to the top, save, and restart sshd and we now have a working sshd which requires 2fa before it lets you in, but also a suite of other strange and confusing behaviour.</p><p>for one, trying to log in via the global ip address has us go through 2fa, and then requests a password. We had password authentication set to off for global, but now it's somehow requiring both. Moreover, attempting to log in through the local network has some strange behaviour. When using a public key, it works as intended, but without, we again require 2fa and password authentication (assuming something doesn't outright break and bug out/close the ssh session without so much as a peep). You may think that disabling PAM on the local side of the sshd config would help solve the issue, but not so. Reviewing the sshconfig manpage, we find that was it the match statment accepts a suite of different overrides, of which PAM isn't one of them - as mentioned earlier, we require a shift in our frame of thinking now that we have PAM enabled as all authentication tasks have been delegated.</p><p>develop techniques for debugging and tracing the issues</p><p>an aside on pam, where it came from and how it works:
complain about the lack of documentation, share your understanding of the stack</p><p>A quick google search about PAM will quickly net you some results on the motivating decision of why PAM exists, as well as some shorter toy examples of how to configure it quickly and easily (I guess technically this is one such example, but I'm trying to be a little more in depth about it)</p><p>in summary, PAM let's application writers utilise external authentication modules, written presumably by authentication experts, without having to hard code any direct authentication themselves. All that is required of an application developer is to make their application PAM aware via the relevant pam library header files and you're off to the races. Binaries such as login or su both use these very same PAM libraries for their authentication, and you can find their config files in /etc/pam.d/ like we could with sshd. On the flip side, PAM also provides an apparently straightforward interface for system administrators to now configure a whole suite of options for each of their pam aware applications, and it really is quite richly featured. An admin is able to set environment variables, have multiple layers of required authentication, have these authentication requirements change on a per user or a per group setting, and it's something we'll be exploiting to get our pubkey + 2fa global vs pubkey or password local working</p><p>What a quick google search won't net you is how to actually use the damn thing in any kind of meaningful way. The documentation itself, while a man page exists for each pam module you have installed, it's very much been written for people who already know what they're doing. The interfaces that exist have been standardised and functional for so long, that finding clear breakdown's it rather difficult since there's seemingly nothing more to say. There are hour long pitfalls to drop in to and climb out of, and so many threads to follow that go nowhere, it really is an exercise in frustration learning how this otherwise wonderfully powerful and flexible system works. For shame, really.</p><p>A nice thing to say, PAM let's a PAM aware application delegate authentication to an admin, who is then responsible for configuring the degree of authentication and accesses they're interested in. The abstract of the pam admin's guide does a good job summarising it in a single sentence.</p><p>One of the few locations I managed to find some actually useful unique information is "The Linux-PAM System Administratos' Guide", but it too falls into a the usual regurgitation of all the man pages. To explain the most pertinent parts:</p><p>An administrator is responsible for configuring the "PAM stack" for any PAM aware applications, which is a series of "PAM modules" that are called during authentication checks. The Linux PAM library is standardised in such a way that an application can blindly call out to the Linux PAM library, which in turn refers to whatever configurations that have been set up for the application and independantly jumps through 4 separate stacks made up of PAM modules. The calling and return values of these PAM modules have been very well standardized as well and their return codes are made visible to administrators. This allow </p><p>+----------------+
| application: X |
+----------------+       /
| authentication-[----&gt;--<br>|       +        [----&lt;--/
|[conversation()]--+    <br>+----------------+  |
|                |  |
|  service user  |
|                |
+----------------+</p><hr><div class="darklight-0-0-5"><div class="dark"><p><em>Hero image by <a href="https://unsplash.com/@kaitlynbaker">Kaitlyn Baker</a> from <a href="https://unsplash.com">Unsplash</a></em></p></div><div class="light"><p><em>Hero image by <a href="https://unsplash.com/@glenncarstenspeters">Glenn Carstens-Peters</a> from <a href="https://unsplash.com">Unsplash</a></em></p></div></div><div class="contentnav-0-0-12" data-no-search=""></div></div><div id="-codedoc-toc" class="toc-0-0-9"><div class="content-0-0-10"><p><a href="/coding-blog-boilerplate/">Home</a>
<a href="/coding-blog-boilerplate/sample-blog-post">Sample Blog Post</a>
<a href="/coding-blog-boilerplate/todo-list">To-do list</a>
<a href="/coding-blog-boilerplate/global-references">Texts</a>
<a href="/coding-blog-boilerplate/00_SSH-and-PAM">First Post</a>
<br><br></p><p>To add links to your other posts,
simply modify contents of <code>posts/_toc.md</code></p></div></div><div class="footer-0-0-8"><div class="left"><script id="uRHuOTjszE">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("uRHuOTjszE", "k0lYj9deiYXngpZFqYY0vQ==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div><div class="main"><div class="inside"></div></div><div class="right"><script id="ADyErrfoyU">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("ADyErrfoyU", "QtGDrozMmpfzLYU0jY3n+w==", {});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></div></div><script id="qdrpqJnABR">(function(){function load(){if (window.__sdh_transport){window.__sdh_transport("qdrpqJnABR", "Rs0VnrLCFSwfOm1o3R6OHg==", {"namespace":"/coding-blog-boilerplate"});} }; if (document.readyState == 'complete') load(); else window.addEventListener('load', load); })()</script></body></html>